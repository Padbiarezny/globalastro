<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>GlobalAstro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background: #f9f9f9; font-family: sans-serif; }
    .mainbox {
      max-width: 380px; margin: 30px auto; background: #fff;
      border-radius: 38px; box-shadow: 0 0 16px #ccc;
      padding: 30px 18px 28px 18px; display: flex; flex-direction: column; align-items: center;
    }
    h1 { text-align: center; font-size: 2em; margin-bottom: 28px; font-weight: 700; }
    .big-btn, .input-btn {
      display: flex; justify-content: center; align-items: center;
      width: 88%; min-height: 82px; margin: 14px auto; font-size: 1.4em;
      border-radius: 32px; border: 1.2px solid #555; background: #fafcff; color: #555;
      font-weight: 500; cursor: pointer; transition: background 0.18s, box-shadow 0.18s;
    }
    .big-btn:active { background: #e8f0fe; }
    .input-btn { min-height: 48px; font-size: 1.13em; border-radius: 22px; }
    .textarea-wrap { width: 88%; margin: 20px auto 10px auto; }
    #question { width: 100%; border-radius: 28px; border: 1.2px solid #555; font-size: 1.17em;
      min-height: 62px; padding: 17px; box-sizing: border-box; margin-bottom: 0; }
    #ask-btn { width: 88%; min-height: 62px; margin: 22px auto 0 auto; font-size: 1.18em;
      border-radius: 32px; background: #007bff; color: #fff; border: none; font-weight: bold; }
    #ask-btn:active { background: #0056b3; }
    /* Модалка */
    .modal-bg {
      display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(80,100,140,0.17); z-index: 99; justify-content: center; align-items: center;
    }
    .modal { background: #fff; border-radius: 18px; padding: 27px 23px; min-width: 260px; box-shadow: 0 0 18px #aaa; }
    .modal label { margin: 8px 0 4px 0; display: block; }
    .modal input, .modal select { width: 100%; padding: 9px; margin-bottom: 14px; border-radius: 7px; border: 1px solid #bbb; }
    .modal-btn-row { display: flex; justify-content: flex-end; }
    .modal-btn { background: #007bff; color: #fff; border: none; border-radius: 7px; padding: 8px 16px; font-size: 1em; cursor: pointer; margin-left: 7px; }
    .modal-btn.cancel { background: #aaa; }
    .option-checkbox { margin-right: 7px; }
  </style>
</head>
<body>
  <div class="mainbox">
    <h1>GlobalAstro</h1>
    <div class="big-btn" onclick="openModal('me')">Мои данные</div>
    <div class="big-btn" onclick="openModal('partner')">Данные партнера<br>(по желанию)</div>
    <div class="big-btn" onclick="openModal('options')">Дополнительные<br>опции по желанию</div>
    <div class="textarea-wrap">
      <textarea id="question" placeholder="Ваш вопрос: Например, как будет складываться работа в июле?"></textarea>
    </div>
    <button id="ask-btn" onclick="getAstroResult()">Получить ответ</button>
    <div id="result" style="margin-top:22px;"></div>
  </div>

  <!-- Модалки -->
  <div class="modal-bg" id="modal-bg">
    <div class="modal" id="modal-me" style="display:none">
      <h3>Мои данные</h3>
      <label>Дата рождения</label>
      <input type="date" id="me-dob">
      <label>Место рождения</label>
      <input type="text" id="me-place">
      <label>Пол</label>
      <select id="me-gender">
        <option value="мужской">Мужской</option>
        <option value="женский">Женский</option>
      </select>
      <label>Время рождения (опционально)</label>
      <input type="time" id="me-time">
      <div class="modal-btn-row">
        <button class="modal-btn cancel" onclick="closeModal()">Отмена</button>
        <button class="modal-btn" onclick="saveMe()">Сохранить</button>
      </div>
    </div>
    <div class="modal" id="modal-partner" style="display:none">
      <h3>Данные партнёра</h3>
      <label>Имя</label>
      <input type="text" id="p-name">
      <label>Дата рождения</label>
      <input type="date" id="p-dob">
      <label>Место рождения</label>
      <input type="text" id="p-place">
      <label>Пол</label>
      <select id="p-gender">
        <option value="">-</option>
        <option value="мужской">Мужской</option>
        <option value="женский">Женский</option>
      </select>
      <label>Время рождения (опционально)</label>
      <input type="time" id="p-time">
      <div class="modal-btn-row">
        <button class="modal-btn cancel" onclick="closeModal()">Отмена</button>
        <button class="modal-btn" onclick="savePartner()">Сохранить</button>
      </div>
    </div>
    <div class="modal" id="modal-options" style="display:none">
      <h3>Доп. опции</h3>
      <label><input type="checkbox" class="option-checkbox" id="opt-num"> Нумерология</label>
      <label><input type="checkbox" class="option-checkbox" id="opt-taro"> Таро</label>
      <label><input type="checkbox" class="option-checkbox" id="opt-china"> Китайский гороскоп</label>
      <label><input type="checkbox" class="option-checkbox" id="opt-more"> Ещё что-нибудь</label>
      <div class="modal-btn-row">
        <button class="modal-btn cancel" onclick="closeModal()">Отмена</button>
        <button class="modal-btn" onclick="saveOptions()">Сохранить</button>
      </div>
    </div>
  </div>
  <script>
    // --- Модалки ---
    function openModal(which) {
      document.getElementById('modal-bg').style.display = "flex";
      document.getElementById('modal-me').style.display = (which === 'me') ? "block" : "none";
      document.getElementById('modal-partner').style.display = (which === 'partner') ? "block" : "none";
      document.getElementById('modal-options').style.display = (which === 'options') ? "block" : "none";
      // Подставим сохранённые значения
      if (which === 'me') {
        ["dob","place","gender","time"].forEach(k => {
          if (localStorage.getItem("astro_me_"+k)) document.getElementById("me-"+k).value = localStorage.getItem("astro_me_"+k);
        });
      }
      if (which === 'partner') {
        ["name","dob","place","gender","time"].forEach(k => {
          if (localStorage.getItem("astro_p_"+k)) document.getElementById("p-"+k).value = localStorage.getItem("astro_p_"+k);
        });
      }
      if (which === 'options') {
        ["num","taro","china","more"].forEach(k => {
          document.getElementById("opt-"+k).checked = !!localStorage.getItem("astro_opt_"+k);
        });
      }
    }
    function closeModal() {
      document.getElementById('modal-bg').style.display = "none";
      ["modal-me","modal-partner","modal-options"].forEach(id => document.getElementById(id).style.display="none");
    }
    function saveMe() {
      ["dob","place","gender","time"].forEach(k => localStorage.setItem("astro_me_"+k, document.getElementById("me-"+k).value));
      closeModal();
    }
    function savePartner() {
      ["name","dob","place","gender","time"].forEach(k => localStorage.setItem("astro_p_"+k, document.getElementById("p-"+k).value));
      closeModal();
    }
    function saveOptions() {
      ["num","taro","china","more"].forEach(k => {
        let id = "opt-"+k;
        if (document.getElementById(id).checked)
          localStorage.setItem("astro_opt_"+k, "1");
        else
          localStorage.removeItem("astro_opt_"+k);
      });
      closeModal();
    }

    // --- Получить астрологический результат ---
    function getAstroResult() {
      // Собираем всё
      let me = {};
      ["dob","place","gender","time"].forEach(k => me[k] = localStorage.getItem("astro_me_"+k) || "");
      let partner = {};
      ["name","dob","place","gender","time"].forEach(k => partner[k] = localStorage.getItem("astro_p_"+k) || "");
      let options = [];
      if (localStorage.getItem("astro_opt_num")) options.push("нумерология");
      if (localStorage.getItem("astro_opt_taro")) options.push("таро");
      if (localStorage.getItem("astro_opt_china")) options.push("китайский гороскоп");
      if (localStorage.getItem("astro_opt_more")) options.push("ещё что-нибудь");
      let question = document.getElementById("question").value.trim();

      // Валидация
      if (!me.dob || !me.place || !me.gender || !question) {
        document.getElementById("result").innerText = "Пожалуйста, заполните минимум ваши данные и сам вопрос!";
        return;
      }

      // Отправка
      document.getElementById("result").innerText = "⏳ Запрос отправлен...";
      document.getElementById("ask-btn").disabled = true;

      fetch("https://globalastro.onrender.com/horoscope", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          me, partner, options,
          question
        })
      })
      .then(res => res.json())
      .then(res => {
        if (res.response) {
          document.getElementById("result").innerText = res.response;
        } else if (res.error) {
          document.getElementById("result").innerText = "Ошибка: " + res.error;
        } else {
          document.getElementById("result").innerText = "Нет ответа от сервера.";
        }
      })
      .catch(err => {
        document.getElementById("result").innerText = "Ошибка соединения: " + err;
      })
      .finally(() => {
        document.getElementById("ask-btn").disabled = false;
      });
    }
  </script>
</body>
</html>
